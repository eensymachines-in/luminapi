version: '3.1'

services:
  nginx:
    build: ./nginx
    ports:
      - "80:80"
    depends_on:
      - "luminapi"
  mosquitto:
    image: eclipse-mosquitto
    ports:
        - "1883:1883"
    volumes:
        # this is where the config is being generated from, so this volume map is important 
        # https://blog.feabhas.com/2020/02/running-the-eclipse-mosquitto-mqtt-broker-in-a-docker-container/
        # http://www.steves-internet-guide.com/mqtt-username-password-example/#:~:text=You%20will%20need%20to%20copy,to%20set%20the%20password_file%20path.
        - ./mosquitto:/mosquitto
    stdin_open: true
    tty:  true
    container_name: mosquitto_broker
  srvmongo:
    image: mongo:4.2-bionic
    ports:
        - 37017:27017
    tty: true
    stdin_open: true
    container_name: authapi_mongo
  luminapi:
    build: .
    volumes:
      - ${LCLDIR}:${LCLDIR}
      - .:${REPODIR}
    ports:
      - 8080:8080
    environment: 
      - LOGF=${LCLDIR}/logs/lumin.log
    stdin_open: ${TTYSTDIN}
    tty:  ${TTYSTDIN}
    links:
      - "mosquitto"
      - "srvmongo"
    secrets:
      - mqtt_secret
    container_name: luminapi_go
    entrypoint: ["go", "run", ".","-flog=${FLOG}", "-verbose=${VERBOSE}"]
secrets:
    mqtt_secret:
      file: ./mqtt.secret
